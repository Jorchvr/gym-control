<%= stylesheet_link_tag "main_panel", media: "all" %>
<div class="split-container" style="justify-content:center;">
  <div class="panel" style="max-width: 1000px; flex: 0 0 100%; width: 100%;">
    
    <div class="header-row">
      <h2 class="title">Historial (<%= @range.to_s.humanize %>)</h2>
      <%= link_to "‚Üê Volver al Inicio", authenticated_root_path, class: "btn" %>
    </div>

    <div class="card history-toolbar">
      <div class="toolbar" style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
        
        <%= form_with url: history_path, method: :get, local: true, class: "search-form", style: "display:flex; gap:.5rem; align-items:center;" do |f| %>
          <label class="text-muted">Fecha:</label>
          <%= date_field_tag :date, @date, class: "form-input", style: "padding: 0.5rem;" %>
          
          <label class="text-muted">Ver:</label>
          <%= select_tag :range,
                options_for_select([["D√≠a","day"],["Semana","week"],["Mes","month"],["A√±o","year"]], @range.to_s),
                class: "filter-select" %>
          
          <%= submit_tag "Filtrar", class: "btn btn-accent" %>
        <% end %>

        <div class="spacer" style="flex:1;"></div>

        <div class="summary" style="display:flex; gap:1.5rem; flex-wrap:wrap; background: rgba(0,0,0,0.3); padding: 0.8rem; border-radius: 12px; border: 1px solid var(--border);">
          <div>
            <small class="text-muted" style="display:block;">BALANCE NETO</small>
            <strong style="color: #10b981; font-size: 1.2rem;">
              <%= number_to_currency(@money_total_cents.to_i / 100.0) %>
            </strong>
          </div>
          <div>
            <small class="text-muted" style="display:block;">EFECTIVO (Caja)</small>
            <strong style="color: #f3f4f6;">
              <%= number_to_currency(@money_by_method["cash"].to_i / 100.0) %>
            </strong>
          </div>
          <div>
            <small class="text-muted" style="display:block;">TRANSFERENCIA</small>
            <strong style="color: #60a5fa;">
              <%= number_to_currency(@money_by_method["transfer"].to_i / 100.0) %>
            </strong>
          </div>
        </div>

      </div>
    </div>

    <div class="history-scroll">
      
      <% if @expenses.any? %>
        <div class="card" style="border-color: rgba(239,68,68,0.4);">
          <h3 class="card-title" style="color: #ef4444;">üîª Salidas de Dinero / Gastos</h3>
          <div class="table-wrap">
            <table class="nice-table">
              <thead><tr><th>Fecha/Hora</th><th>Descripci√≥n</th><th>Usuario</th><th>Monto</th></tr></thead>
              <tbody>
                <% @expenses.each do |ex| %>
                  <tr>
                    <td><%= ex.occurred_at.strftime("%d/%m %H:%M") %></td>
                    <td><%= ex.description %></td>
                    <td><%= ex.user.name %></td>
                    <td style="color: #ef4444; font-weight: bold;">
                      -<%= number_to_currency(ex.amount_cents.to_i / 100.0) %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>

      <div class="grid-2" style="gap:1rem; margin-top:1rem;">
        
        <div class="card">
          <h3 class="card-title">Ventas de Membres√≠a</h3>
          <% if @sales.any? %>
            <div class="table-wrap">
              <table class="nice-table">
                <thead><tr><th>Hora</th><th>Usuario</th><th>Cliente</th><th>Membres√≠a</th><th>Pago</th><th>Monto</th></tr></thead>
                <tbody>
                  <% @sales.each do |s| %>
                    <tr>
                      <td><%= (s.occurred_at || s.created_at)&.in_time_zone&.strftime("%H:%M") %></td>
                      <td><%= s.user&.name %></td>
                      <td><%= s.client&.name || "-" %></td>
                      <td><%= s.membership_type %></td>
                      <td><%= s.payment_method %></td>
                      <td style="color: #10b981;"><%= number_to_currency(s.amount_cents.to_i / 100.0) %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted">Sin ventas de membres√≠a en el rango.</p>
          <% end %>
        </div>

        <div class="card">
          <h3 class="card-title">Ventas de Tienda</h3>
          <% if @store_sales.any? %>
            <div class="table-wrap">
              <table class="nice-table">
                <thead><tr><th>Hora</th><th>Usuario</th><th>ID</th><th>Pago</th><th>Total</th></tr></thead>
                <tbody>
                  <% @store_sales.each do |ss| %>
                    <tr>
                      <td><%= (ss.occurred_at || ss.created_at)&.in_time_zone&.strftime("%H:%M") %></td>
                      <td><%= ss.user&.name %></td>
                      <td>#<%= ss.id %></td>
                      <td><%= ss.payment_method %></td>
                      <td style="color: #10b981;"><%= number_to_currency(ss.total_cents.to_i / 100.0) %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted">Sin ventas de tienda en el rango.</p>
          <% end %>
        </div>

      </div>

      <div class="grid-2 mt-6">
        
        <div class="card">
          <h3 class="card-title">Resumen de Productos Vendidos</h3>
          <% if @sold_by_product.any? %>
            <div class="table-wrap">
              <table class="nice-table">
                <thead><tr><th>Producto</th><th>Cant. Vendida</th><th>Ingreso</th><th>Stock Actual</th></tr></thead>
                <tbody>
                  <% @sold_by_product.each do |row| %>
                    <tr>
                      <td><%= row[:product_name] %></td>
                      <td><%= row[:sold_qty] %></td>
                      <td><%= number_to_currency(row[:revenue_cents] / 100.0) %></td>
                      <td><%= row[:remaining_stock] %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted">No se vendieron productos en este periodo.</p>
          <% end %>
        </div>

        <div class="card">
          <h3 class="card-title">Nuevos Clientes (<%= @new_clients.count %>)</h3>
          <% if @new_clients.any? %>
            <div class="table-wrap">
              <table class="nice-table">
                <thead><tr><th>Fecha</th><th>Nombre</th><th>Registr√≥</th></tr></thead>
                <tbody>
                  <% @new_clients.each do |c| %>
                    <tr>
                      <td><%= c.created_at&.in_time_zone&.strftime("%d/%m %H:%M") %></td>
                      <td><%= c.name %></td>
                      <td><%= c.user&.name %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted">Sin clientes nuevos.</p>
          <% end %>
        </div>

      </div>

    </div> </div>
</div>