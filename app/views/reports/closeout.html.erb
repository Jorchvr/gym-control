<%= stylesheet_link_tag "main_panel", media: "all", "data-turbo-track": "reload" %>
<%= stylesheet_link_tag "closeout",   media: "all", "data-turbo-track": "reload" %>

<% generated_at = Time.zone.now %>

<div class="ticket-page">
  <div class="ticket-wrapper">
    <div class="ticket-card">
      <!-- ================= CABECERA ================= -->
      <header class="ticket-header">
        <div class="ticket-logo-wrap">
          <%= image_tag "logo.png", alt: "Logo PowerGym", class: "ticket-logo" %>
        </div>
        <div class="ticket-header-text">
          <h1 class="ticket-title">PowerGym</h1>
          <p class="ticket-subtitle">CORTE DEL D√çA</p>
          <p class="ticket-date">
            <%= @date.strftime("%Y-%m-%d") %> ¬∑
            <%= generated_at.strftime("%H:%M") %>
          </p>
        </div>
      </header>

      <section class="ticket-section ticket-section--user">
        <div class="ticket-row">
          <div class="ticket-row-left">
            <span class="ticket-label">Usuario</span>
          </div>
          <div class="ticket-row-right">
            <span class="ticket-mono"><%= @user_name %></span>
          </div>
        </div>
      </section>

      <!-- ========== RESUMEN GENERAL ========== -->
      <% membership_total_cents =
           (@transactions || []).select { |t| t[:label].to_s.start_with?("Membres√≠a") }
                               .sum { |t| t[:amount_cents].to_i }

         store_total_cents =
           (@transactions || []).select { |t|
             t[:label].to_s.start_with?("Tienda") && t[:amount_cents].to_i >= 0
           }.sum { |t| t[:amount_cents].to_i }

         adjustments_cents =
           (@transactions || []).select { |t| t[:amount_cents].to_i < 0 }
                               .sum { |t| t[:amount_cents].to_i }

         # üîê Evitar error cuando @by_method es nil
         cash_cents     = (@by_method || {})["cash"].to_i
         transfer_cents = (@by_method || {})["transfer"].to_i
      %>

      <section class="ticket-section">
        <h3 class="ticket-section-title">RESUMEN GENERAL</h3>

        <div class="ticket-row">
          <div class="ticket-row-left">Operaciones totales</div>
          <div class="ticket-row-right ticket-mono"><%= @ops_count %></div>
        </div>

        <div class="ticket-row">
          <div class="ticket-row-left">Ventas de membres√≠a</div>
          <div class="ticket-row-right ticket-mono">
            MXN <%= number_to_currency(membership_total_cents / 100.0, unit: "", precision: 2) %>
          </div>
        </div>

        <div class="ticket-row">
          <div class="ticket-row-left">Ventas de tienda</div>
          <div class="ticket-row-right ticket-mono">
            MXN <%= number_to_currency(store_total_cents / 100.0, unit: "", precision: 2) %>
          </div>
        </div>

        <div class="ticket-row ticket-row--negative">
          <div class="ticket-row-left">Ajustes / ventas negativas</div>
          <div class="ticket-row-right ticket-mono">
            MXN <%= number_to_currency(adjustments_cents / 100.0, unit: "", precision: 2) %>
          </div>
        </div>

        <div class="ticket-row ticket-row--total">
          <div class="ticket-row-left"><strong>Total del d√≠a</strong></div>
          <div class="ticket-row-right ticket-mono">
            <strong>
              MXN <%= number_to_currency(@total_cents.to_i / 100.0, unit: "", precision: 2) %>
            </strong>
          </div>
        </div>
      </section>

      <!-- ========== M√âTODOS DE PAGO ========== -->
      <section class="ticket-section">
        <h3 class="ticket-section-title">M√âTODOS DE PAGO</h3>

        <div class="ticket-row">
          <div class="ticket-row-left">Efectivo</div>
          <div class="ticket-row-right ticket-mono">
            MXN <%= number_to_currency(cash_cents / 100.0, unit: "", precision: 2) %>
          </div>
        </div>

        <div class="ticket-row">
          <div class="ticket-row-left">Transferencia</div>
          <div class="ticket-row-right ticket-mono">
            MXN <%= number_to_currency(transfer_cents / 100.0, unit: "", precision: 2) %>
          </div>
        </div>
      </section>

      <!-- ========== ACTIVIDAD DE CLIENTES ========== -->
      <section class="ticket-section">
        <h3 class="ticket-section-title">ACTIVIDAD DE CLIENTES</h3>

        <div class="ticket-row">
          <div class="ticket-row-left">Entradas (check-ins)</div>
          <div class="ticket-row-right ticket-mono"><%= @checkins_today %></div>
        </div>

        <div class="ticket-row">
          <div class="ticket-row-left">Nuevos clientes</div>
          <div class="ticket-row-right ticket-mono"><%= @new_clients_today %></div>
        </div>
      </section>

      <!-- ========== PRODUCTOS VENDIDOS ========== -->
      <section class="ticket-section">
        <h3 class="ticket-section-title">PRODUCTOS VENDIDOS</h3>

        <% if @sold_by_product.present? %>
          <% @sold_by_product.each do |row| %>
            <div class="ticket-row">
              <div class="ticket-row-left">
                <span class="ticket-text-strong">
                  <%= row[:product_name] %> x<%= row[:sold_qty] %>
                </span>
              </div>
              <div class="ticket-row-right">
                <span class="ticket-mono">
                  MXN <%= number_to_currency(row[:revenue_cents].to_i / 100.0,
                                             unit: "",
                                             precision: 2) %>
                </span>
              </div>
            </div>
          <% end %>
        <% else %>
          <p class="ticket-empty muted">No hay productos vendidos en este turno.</p>
        <% end %>
      </section>

      <!-- ========== FOOTER ========== -->
      <footer class="ticket-footer">
        <p class="ticket-thanks">¬°Gracias por tu trabajo hoy! üí™</p>
        <p class="ticket-generated-at">
          Corte generado el <%= @date.strftime("%Y-%m-%d") %> ¬∑ <%= generated_at.strftime("%H:%M") %>
        </p>

        <div class="ticket-barcode">
          <div class="ticket-barcode-lines">
            <% 26.times do |i| %>
              <span class="ticket-bar-line <%= 'ticket-bar-line--thin' if i.even? %>"></span>
            <% end %>
          </div>
        </div>
      </footer>
    </div>
  </div>
</div>
