<%= stylesheet_link_tag "main_panel", media: "all" %>

<!-- Sólo para esta vista: scroll y encabezado sticky -->
<style>
  .scroll-y {
    max-height: 380px;       /* ajusta el alto del área scrolleable */
    overflow-y: auto;
    overscroll-behavior: contain;
    scrollbar-gutter: stable; /* evita salto de layout al aparecer scrollbar */
  }
  /* Encabezado fijo por columna (mejor compatibilidad) */
  .table thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background: rgba(0,0,0,.15); /* contraste con el body */
    backdrop-filter: blur(2px);
  }
</style>

<div class="header-row">
  <h2 class="title">Corte del Día</h2>
  <div style="display:flex; gap:.6rem; flex-wrap:wrap;">
    <%= link_to "Inicio", authenticated_root_path, class: "btn" %>
  </div>
</div>

<div class="grid-2" style="gap:1rem;">
  <div class="card" style="overflow: visible;">
    <h3 class="card-title">Resumen</h3>
    <div class="kv"><span>Usuario</span><span><%= @user_name %></span></div>
    <div class="kv"><span>Fecha</span><span><%= @date.to_s %></span></div>
    <div class="kv"><span>Operaciones</span><span><%= @ops_count %></span></div>
    <div class="kv"><span>Total</span><span><%= number_to_currency(@total_cents/100.0, unit: "MXN $", precision: 2) %></span></div>
    <div class="kv"><span>Efectivo</span><span><%= number_to_currency(@by_method["cash"]/100.0, unit: "MXN $", precision: 2) %></span></div>
    <div class="kv"><span>Transferencia</span><span><%= number_to_currency(@by_method["transfer"]/100.0, unit: "MXN $", precision: 2) %></span></div>
  </div>

  <div class="card" style="overflow: visible;">
    <h3 class="card-title">Indicadores del día</h3>
    <div class="kv"><span>Nuevos clientes</span><span><%= @new_clients_today %></span></div>
    <div class="kv"><span>Entradas (check-ins)</span><span><%= @checkins_today %></span></div>
    <div class="kv"><span>Stock total actual</span><span><%= @stock_total_units %> uds</span></div>
  </div>
</div>

<div class="card" style="margin-top:1rem; overflow: visible;">
  <h3 class="card-title">Movimientos del turno</h3>
  <!-- ⬇️ Área con scroll -->
  <div class="scroll-y">
    <% if @transactions.any? %>
      <table class="table">
        <thead>
          <tr><th>Hora</th><th>Detalle</th><th>Método</th><th>Monto</th></tr>
        </thead>
        <tbody>
          <% @transactions.each do |t| %>
            <tr>
              <td><%= t[:at]&.in_time_zone&.strftime("%H:%M") %></td>
              <td><%= t[:label] %></td>
              <td><%= t[:payment_method] %></td>
              <td><%= number_to_currency(t[:amount_cents].to_i / 100.0, unit: "MXN $", precision: 2) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="text-muted">Sin movimientos en el turno.</p>
    <% end %>
  </div>
</div>

<!-- ===== Detalle por producto vendido en el turno ===== -->
<div class="card" style="margin-top:1rem; overflow: visible;">
  <h3 class="card-title">Productos vendidos (detalle del turno)</h3>
  <!-- ⬇️ Área con scroll -->
  <div class="scroll-y">
    <% if @sold_by_product.present? && @sold_by_product.any? %>
      <table class="table">
        <thead>
          <tr>
            <th>Producto</th>
            <th style="text-align:right;">Vendido (uds)</th>
            <th style="text-align:right;">Ingresos</th>
            <th style="text-align:right;">Stock restante</th>
          </tr>
        </thead>
        <tbody>
          <% @sold_by_product.each do |row| %>
            <tr>
              <td><%= row[:product_name] %></td>
              <td style="text-align:right;"><%= row[:sold_qty] %></td>
              <td style="text-align:right;"><%= number_to_currency(row[:revenue_cents].to_i / 100.0, unit: "MXN $", precision: 2) %></td>
              <td style="text-align:right;"><%= row[:remaining_stock] %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="text-muted">No se vendieron productos en el turno.</p>
    <% end %>
  </div>
</div>
