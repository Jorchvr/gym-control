<%= stylesheet_link_tag "main_panel", media: "all", "data-turbo-track": "reload" %>

<%# Recarga si estamos en modo autom√°tico %>
<% if @is_scanning && !@client.fingerprint.present? %>
  <meta http-equiv="refresh" content="3">
<% end %>

<div class="card">
  <div class="header-row" style="justify-content: space-between; align-items: center;">
    <h2 class="title">Ficha de Cliente</h2>
    <div class="btn-row">
      <%= link_to "Inicio", authenticated_root_path, class: "btn" %>
      <%= link_to "Clientes", clients_path, class: "btn" %>
      <%= link_to "Editar", edit_client_path(@client), class: "btn btn-primary" %>
    </div>
  </div>

  <div class="grid-2">
    <div>
      <%= client_photo_tag(@client, size: 160, classes: "client-photo--xl") %>
    </div>
    <div>
      <h3 class="result-name"><%= @client.name %></h3>
      <p class="result-meta">#<%= @client.id %> ‚Ä¢ <%= @client.membership_type&.humanize || "Sin plan" %></p>
      <div class="result-kv"><span>Inscripci√≥n</span><span><%= @client.enrolled_on || "-" %></span></div>
      <div class="result-kv"><span>Pr√≥ximo pago</span><span><%= @client.next_payment_on || "-" %></span></div>
      <div class="mt-4 btn-row">
        <%= link_to "Cobrar mensualidad", memberships_path(q: @client.id), class: "btn btn-accent" %>
      </div>
    </div>
  </div>
</div>

<div class="card" style="margin-top: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
    <h3 class="title" style="font-size:1.1rem; margin:0;">üîê Gesti√≥n de Huella</h3>
    
    <% if @client.fingerprint.present? %>
      <span style="color: #34d399; font-weight:bold; background: rgba(52, 211, 153, 0.1); padding: 5px 10px; border-radius: 6px;">
        ‚úÖ Registrada
      </span>
    <% else %>
      <span style="color: #f87171; font-weight:bold; background: rgba(248, 113, 113, 0.1); padding: 5px 10px; border-radius: 6px;">
        ‚ö†Ô∏è No asignada
      </span>
    <% end %>
  </div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
    
    <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
      <h4 style="font-size: 0.9rem; color: #888; margin-bottom: 0.5rem;">Opci√≥n A: Autom√°tica</h4>
      <% if @is_scanning %>
        <button class="btn btn-warning w-100" disabled>‚è≥ ESCANEANDO...</button>
        <small style="color: #fbbf24; display:block; margin-top:5px;">Pon el dedo ahora...</small>
      <% else %>
        <%= button_to "üëÜ Iniciar Escaneo", 
              start_registration_client_path(@client), 
              method: :post, 
              class: "btn btn-primary w-100", 
              form: { data: { turbo: false } } %> 
      <% end %>
    </div>

    <div style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border: 1px dashed #10b981; border-radius: 8px;">
      <h4 style="font-size: 0.9rem; color: #10b981; margin-bottom: 0.5rem;">Opci√≥n B: Manual (Recomendada)</h4>
      <p style="font-size: 0.8rem; color: #ccc; margin-bottom: 10px;">
        1. Pon el dedo en el lector primero.<br>
        2. Luego pulsa este bot√≥n.
      </p>
      <%= button_to "üîó VINCULAR √öLTIMA LE√çDA", 
            attach_last_fingerprint_client_path(@client), 
            method: :post, 
            class: "btn btn-success w-100",
            style: "background-color: #059669; border: none; font-weight: bold;" %>
    </div>

  </div>
</div>